<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能源监控系统</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Socket.IO 不再注释 -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 我们不再需要模拟数据脚本 -->
    <!-- <script src="js/mock-data.js"></script> -->
    <style>
        /* 基本样式 */
        :root {
            --primary-color: #00a8ff;
            --secondary-color: #0097e6;
            --accent-color: #00e676;
            --dark-bg: #0c1445;
            --darker-bg: #060d2c;
            --card-bg: rgba(13, 28, 75, 0.8);
            --border-color: rgba(0, 168, 255, 0.3);
            --text-color: #e4f1fe;
            --text-secondary: #a5b1c2;
            --success-color: #00e676;
            --warning-color: #ffb142;
            --danger-color: #ff5252;
            --battery-color: #4cd137;
            --solar-color: #ffa502;
            --grid-color: #9c88ff;
            --weather-color: #1e90ff;
            --price-color: #ff6b81;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', 'Microsoft YaHei', Arial, sans-serif;
            background-color: var(--darker-bg);
            color: var(--text-color);
            background-image: url('https://img.freepik.com/free-vector/abstract-technology-particle-background_52683-25766.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(6, 13, 44, 0.85);
            z-index: -1;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 头部样式 */
        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(to right, rgba(6, 13, 44, 0.8), rgba(12, 20, 69, 0.8), rgba(6, 13, 44, 0.8));
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: headerGlow 5s infinite alternate;
        }
        
        @keyframes headerGlow {
            0% { box-shadow: 0 4px 12px rgba(0, 168, 255, 0.1); }
            100% { box-shadow: 0 4px 20px rgba(0, 168, 255, 0.4); }
        }
        
        header::before, header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            width: 25%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            animation: headerLinePulse 3s infinite alternate;
        }
        
        @keyframes headerLinePulse {
            0% { opacity: 0.6; width: 15%; }
            100% { opacity: 1; width: 30%; }
        }
        
        header::before {
            left: 0;
        }
        
        header::after {
            right: 0;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            text-shadow: 0 0 15px rgba(0, 168, 255, 0.6);
            position: relative;
            display: inline-block;
            letter-spacing: 1px;
            font-weight: 700;
            animation: titleGlow 3s infinite alternate;
        }
        
        @keyframes titleGlow {
            0% { text-shadow: 0 0 10px rgba(0, 168, 255, 0.3); }
            100% { text-shadow: 0 0 20px rgba(0, 168, 255, 0.8); }
        }
        
        h1::before, h1::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30px;
            height: 4px;
            background-color: var(--accent-color);
            transform: translateY(-50%);
            animation: decorPulse 2s infinite alternate;
        }
        
        @keyframes decorPulse {
            0% { width: 20px; opacity: 0.6; }
            100% { width: 40px; opacity: 1; }
        }
        
        h1::before {
            left: -50px;
        }
        
        h1::after {
            right: -50px;
        }
        
        header p {
            color: var(--text-secondary);
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
            font-weight: 300;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        /* 添加时间和状态显示 */
        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            padding: 0 10%;
        }
        
        .current-time, .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status.online {
            background-color: rgba(0, 230, 118, 0.2);
            color: var(--success-color);
            border: 1px solid rgba(0, 230, 118, 0.3);
        }
        
        .status.offline {
            background-color: rgba(255, 82, 82, 0.2);
            color: var(--danger-color);
            border: 1px solid rgba(255, 82, 82, 0.3);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            header p {
                font-size: 1rem;
            }
            
            .header-info {
                flex-direction: column;
                gap: 10px;
            }
            
            h1::before, h1::after {
                display: none;
            }
        }
        
        /* 仪表盘卡片基本样式 */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .card {
            background: linear-gradient(135deg, rgba(13, 28, 75, 0.8), rgba(6, 13, 44, 0.9));
            border-radius: 15px;
            padding: 25px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }
        
        /* 系统供电状态卡片样式 */
        .system-card {
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, rgba(13, 28, 75, 0.8), rgba(6, 13, 44, 0.9));
            border: 1px solid rgba(0, 168, 255, 0.5);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        .system-card::before {
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--primary-color));
            height: 6px;
        }
        
        .system-card h3 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .system-card .value {
            font-size: 3rem;
        }
        
        .system-card .system-status {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            margin-top: 15px;
        }
        
        .system-card .status-item {
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            min-width: 100px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .system-card .status-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .system-card .status-item i {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: block;
        }
        
        .system-card .status-item.active i {
            color: var(--success-color);
        }
        
        .system-card .status-item.inactive i {
            color: var(--text-secondary);
        }
        
        /* 基本卡片样式 */
        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }
        
        .card h3 {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 15px;
            position: relative;
            display: inline-block;
        }
        
        .card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(0, 168, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .card .unit {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .card .icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5rem;
            opacity: 0.2;
            color: var(--primary-color);
        }
        
        .card .status-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
            font-weight: 500;
        }
        
        .status-indicator.charging {
            background-color: rgba(0, 230, 118, 0.2);
            color: var(--success-color);
            border: 1px solid rgba(0, 230, 118, 0.3);
        }
        
        .status-indicator.discharging {
            background-color: rgba(255, 159, 67, 0.2);
            color: #ff9f43;
            border: 1px solid rgba(255, 159, 67, 0.3);
        }
        
        .status-indicator.full {
            background-color: rgba(156, 136, 255, 0.2);
            color: #9c88ff;
            border: 1px solid rgba(156, 136, 255, 0.3);
        }
        
        .status-indicator.solar {
            background-color: rgba(255, 165, 2, 0.2);
            color: #ffa502;
            border: 1px solid rgba(255, 165, 2, 0.3);
        }
        
        .status-indicator.grid {
            background-color: rgba(9, 132, 227, 0.2);
            color: #0984e3;
            border: 1px solid rgba(9, 132, 227, 0.3);
        }
        
        /* 天气卡片 */
        .weather-card {
            display: flex;
            flex-direction: column;
        }
        
        .weather-card .weather-icon {
            font-size: 3rem;
            margin: 10px 0;
            color: var(--weather-color);
        }
        
        .weather-card .weather-details {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        
        .weather-card .weather-detail-item {
            text-align: center;
        }
        
        .weather-card .weather-detail-item i {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }
        
        /* 电价卡片 */
        .price-card .price-level {
            font-size: 1.2rem;
            margin-top: 10px;
            font-weight: 500;
        }
        
        .price-card .next-change {
            font-size: 0.9rem;
            margin-top: 10px;
            color: var(--text-secondary);
        }
        
        .price-card .price-level.peak {
            color: var(--danger-color);
        }
        
        .price-card .price-level.normal {
            color: var(--warning-color);
        }
        
        .price-card .price-level.valley {
            color: var(--success-color);
        }
        
        /* 图表容器样式 */
        .chart-section {
            margin-bottom: 40px;
            background: linear-gradient(135deg, rgba(13, 28, 75, 0.8), rgba(6, 13, 44, 0.9));
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .chart-section h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            text-shadow: 0 0 10px rgba(0, 168, 255, 0.3);
        }
        
        .chart-container {
            width: 100%;
            height: 400px;
            position: relative;
            background-color: rgba(6, 13, 44, 0.5);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(0, 168, 255, 0.2);
        }
        
        .chart-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .chart-tab {
            padding: 10px 20px;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .chart-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .chart-content {
            display: none;
        }
        
        .chart-content.active {
            display: block;
        }
        
        /* 数据表格样式 */
        .data-section {
            background: linear-gradient(135deg, rgba(13, 28, 75, 0.8), rgba(6, 13, 44, 0.9));
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            margin-bottom: 40px;
        }
        
        .data-section h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            text-shadow: 0 0 10px rgba(0, 168, 255, 0.3);
        }
        
        .data-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }
        
        .data-tab {
            padding: 10px 20px;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .data-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .data-content {
            display: none;
        }
        
        .data-content.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            color: var(--text-color);
            background-color: rgba(6, 13, 44, 0.5);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(0, 168, 255, 0.2);
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        table th {
            background-color: rgba(0, 168, 255, 0.2);
            font-weight: 500;
            color: var(--primary-color);
            position: relative;
            text-shadow: 0 0 5px rgba(0, 168, 255, 0.3);
        }
        
        table th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, var(--primary-color), transparent);
        }
        
        table tr:hover {
            background-color: rgba(0, 168, 255, 0.1);
        }
        
        /* 状态指示器样式 */
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status.online {
            background-color: rgba(0, 230, 118, 0.2);
            color: var(--success-color);
            border: 1px solid rgba(0, 230, 118, 0.3);
        }
        
        .status.offline {
            background-color: rgba(255, 82, 82, 0.2);
            color: var(--danger-color);
            border: 1px solid rgba(255, 82, 82, 0.3);
        }
        
        /* 页脚样式 */
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
        }
        
        /* 动画效果 */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 168, 255, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(0, 168, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 168, 255, 0);
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .system-card .system-status {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .chart-container {
                height: 300px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            h1::before, h1::after {
                display: none;
            }
            
            .data-tabs {
                flex-wrap: nowrap;
            }
        }
        
        /* 装饰元素 */
        .decoration {
            position: absolute;
            background-color: var(--primary-color);
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.1;
            z-index: -1;
        }
        
        .decoration-1 {
            top: 10%;
            left: 10%;
            width: 300px;
            height: 300px;
            background-color: var(--primary-color);
        }
        
        .decoration-2 {
            bottom: 20%;
            right: 10%;
            width: 400px;
            height: 400px;
            background-color: var(--accent-color);
        }
        
        /* 数据标签 */
        .data-label {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 168, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 0.8rem;
            color: var(--primary-color);
        }
        
        /* 网格背景 */
        .grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(13, 28, 75, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(13, 28, 75, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            z-index: -1;
        }
        
        /* 电池样式 */
        .battery-container {
            width: 100px;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            position: relative;
            margin: 15px auto;
        }
        
        .battery-container::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -8px;
            transform: translateY(-50%);
            width: 8px;
            height: 20px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 0 3px 3px 0;
        }
        
        .battery-level {
            height: 100%;
            background: linear-gradient(90deg, #4cd137, #44bd32);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        .battery-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
        }
        
        /* 数据来源和实时指示器样式 */
        .data-source {
            font-size: 0.7rem;
            margin-top: 5px;
            color: var(--text-secondary);
        }
        
        .real-time-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 230, 118, 0.2);
            color: var(--success-color);
            border: 1px solid rgba(0, 230, 118, 0.3);
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .real-time-indicator i {
            font-size: 0.6rem;
        }
    </style>
</head>
<body>
    <div class="grid-bg"></div>
    <div class="decoration decoration-1"></div>
    <div class="decoration decoration-2"></div>
    
    <div class="container">
        <header>
            <h1>能源监控系统</h1>
            <p>实时监测电池状态、太阳能发电、天气情况和电价变动，让能源管理更加高效智能</p>
            <div class="header-info">
                <div class="current-time">
                    <i class="fas fa-clock"></i>
                    <span id="current-time">2023-09-10 12:00:00</span>
                </div>
                <div class="connection-status">
                    <i class="fas fa-wifi"></i>
                    <span id="connectionStatus" class="status online">已连接</span>
                </div>
            </div>
        </header>
        
        <!-- 第一排：系统供电状态卡片 -->
        <div class="dashboard" style="margin-bottom: 20px; display: flex; justify-content: center;">
            <div class="card system-card" style="width: 50%; grid-column: auto;">
                <div class="icon"><i class="fas fa-plug"></i></div>
                <h3>系统供电状态</h3>
                <div class="value" id="load-power">0</div>
                <div class="unit">W</div>
                <div class="system-status">
                    <div class="status-item" id="solar-power-status">
                        <i class="fas fa-sun"></i>
                        <div>太阳能供电</div>
                        <div id="solar-status-text">未知</div>
                    </div>
                    <div class="status-item" id="grid-power-status">
                        <i class="fas fa-bolt"></i>
                        <div>电网供电</div>
                        <div id="grid-status-text">未知</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 第二排：其他卡片 -->
        <div class="dashboard">
            <!-- 电池状态卡片 -->
            <div class="card">
                <div class="icon"><i class="fas fa-car-battery"></i></div>
                <h3>电池状态</h3>
                <div class="battery-container">
                    <div class="battery-level" id="battery-level"></div>
                    <div class="battery-text" id="battery-percentage">0%</div>
                </div>
                <div class="value" id="battery-voltage">0</div>
                <div class="unit">V</div>
                <div class="status-indicator" id="battery-status">未知</div>
            </div>
            
            <!-- 太阳能板卡片 -->
            <div class="card">
                <div class="icon"><i class="fas fa-solar-panel"></i></div>
                <h3>太阳能板</h3>
                <div class="value" id="solar-power">0</div>
                <div class="unit">W</div>
                <div class="unit" id="solar-voltage">电压: 0V</div>
                <div class="unit" id="solar-current">电流: 0A</div>
                <div class="unit" id="solar-efficiency">效率: 0%</div>
            </div>
            
            <!-- 天气卡片 -->
            <div class="card weather-card">
                <h3>天气状况 <span id="weather-source">(心知天气API)</span></h3>
                <div id="weather-icon" class="weather-icon">
                    <i class="fas fa-cloud"></i>
                </div>
                <div id="weather-condition" class="value">霾</div>
                <div id="weather-temperature" class="value">24.0°C</div>
            </div>
            
            <!-- 电价卡片 -->
            <div class="card price-card">
                <div class="icon"><i class="fas fa-money-bill-wave"></i></div>
                <h3>电价信息</h3>
                <div class="value" id="electricity-price">0.00</div>
                <div class="unit">元/kWh</div>
                <div class="price-level" id="price-level">平价</div>
                <div class="next-change" id="next-price-change">下次变动: 未知</div>
                <div class="data-source" id="price-data-source"></div>
                <div class="real-time-indicator">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <span>湖北省实时电价</span>
                </div>
            </div>
        </div>
        
        <div class="chart-section">
            <h2>数据趋势分析</h2>
            <div class="data-label">实时更新</div>
            
            <!-- 移除图表标签切换，将每个图表单独占一行 -->
            <div style="display: flex; flex-direction: column; gap: 30px; margin-bottom: 20px;">
                <!-- 显示能源数据图表 -->
                <div class="chart-container" style="height: 300px;">
                    <h3 style="text-align: center; margin-bottom: 10px; color: var(--primary-color);">能源数据</h3>
                    <canvas id="energyChart"></canvas>
                </div>
                
                <!-- 显示电池数据图表 -->
                <div class="chart-container" style="height: 300px;">
                    <h3 style="text-align: center; margin-bottom: 10px; color: var(--battery-color);">电池数据</h3>
                    <canvas id="batteryChart"></canvas>
                </div>
                
                <!-- 显示太阳能数据图表 -->
                <div class="chart-container" style="height: 300px;">
                    <h3 style="text-align: center; margin-bottom: 10px; color: var(--solar-color);">太阳能数据</h3>
                    <canvas id="solarChart"></canvas>
                </div>
            </div>
            
            <!-- 移除其他图表的标签切换和显示部分 -->
        </div>
        
        <div class="data-section">
            <h2>历史数据记录</h2>
            
            <div class="data-tabs">
                <div class="data-tab active" data-table="battery">电池数据</div>
                <div class="data-tab" data-table="solar">太阳能数据</div>
                <div class="data-tab" data-table="power">供电状态</div>
                <div class="data-tab" data-table="weather">天气数据</div>
                <div class="data-tab" data-table="price">电价数据</div>
            </div>
            
            <div class="data-content active" data-content="battery">
                <table id="batteryTable">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>电压 (V)</th>
                            <th>容量 (%)</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 数据将通过 JavaScript 动态填充 -->
                    </tbody>
                </table>
            </div>
            
            <div class="data-content" data-content="solar">
                <table id="solarTable">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>电压 (V)</th>
                            <th>电流 (A)</th>
                            <th>功率 (W)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 数据将通过 JavaScript 动态填充 -->
                    </tbody>
                </table>
            </div>
            
            <div class="data-content" data-content="power">
                <table id="powerTable">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>供电来源</th>
                            <th>电网状态</th>
                            <th>太阳能状态</th>
                            <th>负载功率 (W)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 数据将通过 JavaScript 动态填充 -->
                    </tbody>
                </table>
            </div>
            
            <div class="data-content" data-content="weather">
                <table id="weatherTable">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>温度 (°C)</th>
                            <th>天气状况</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 数据将通过 JavaScript 动态填充 -->
                    </tbody>
                </table>
            </div>
            
            <div class="data-content" data-content="price">
                <table id="priceTable">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>电价 (元/kWh)</th>
                            <th>电价等级</th>
                            <th>下次变动时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 数据将通过 JavaScript 动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // 连接到 Socket.IO 服务
        const socket = io();
        
        // 获取 DOM 元素 - 电池状态
        const batteryVoltageElement = document.getElementById('battery-voltage');
        const batteryPercentageElement = document.getElementById('battery-percentage');
        const batteryLevelElement = document.getElementById('battery-level');
        const batteryStatusElement = document.getElementById('battery-status');
        
        // 获取 DOM 元素 - 太阳能板
        const solarPowerElement = document.getElementById('solar-power');
        const solarVoltageElement = document.getElementById('solar-voltage');
        const solarCurrentElement = document.getElementById('solar-current');
        const solarEfficiencyElement = document.getElementById('solar-efficiency');
        
        // 获取 DOM 元素 - 系统供电状态
        const loadPowerElement = document.getElementById('load-power');
        const solarPowerStatusElement = document.getElementById('solar-power-status');
        const gridPowerStatusElement = document.getElementById('grid-power-status');
        const solarStatusTextElement = document.getElementById('solar-status-text');
        const gridStatusTextElement = document.getElementById('grid-status-text');
        
        // 获取 DOM 元素 - 天气
        const weatherIconElement = document.getElementById('weather-icon');
        const weatherConditionElement = document.getElementById('weather-condition');
        const weatherTemperatureElement = document.getElementById('weather-temperature');
        const weatherSourceElement = document.getElementById('weather-source');
        
        // 获取 DOM 元素 - 电价
        const electricityPriceElement = document.getElementById('electricity-price');
        const priceLevelElement = document.getElementById('price-level');
        const nextPriceChangeElement = document.getElementById('next-price-change');
        
        // 获取 DOM 元素 - 连接状态（检查是否存在）
        const connectionStatus = document.getElementById('connectionStatus');
        
        // 获取表格元素
        const batteryTableBody = document.querySelector('#batteryTable tbody');
        const solarTableBody = document.querySelector('#solarTable tbody');
        const powerTableBody = document.querySelector('#powerTable tbody');
        const weatherTableBody = document.querySelector('#weatherTable tbody');
        const priceTableBody = document.querySelector('#priceTable tbody');
        
        // 初始化图表
        Chart.defaults.color = 'rgba(228, 241, 254, 0.7)';
        Chart.defaults.font.family = "'Roboto', 'Microsoft YaHei', Arial, sans-serif";
        
        function initCharts() {
            // 能源数据图表
            const energyChartCtx = document.getElementById('energyChart').getContext('2d');
            energyChart = new Chart(energyChartCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '电池电压 (V)',
                            data: [],
                            borderColor: '#00a8ff',
                            backgroundColor: 'rgba(0, 168, 255, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: '太阳能功率(W)',
                            data: [],
                            borderColor: '#ffa502',
                            backgroundColor: 'rgba(255, 165, 2, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        },
                        {
                            label: '系统负载 (W)',
                            data: [],
                            borderColor: '#00e676',
                            backgroundColor: 'rgba(0, 230, 118, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(13, 28, 75, 0.9)',
                            borderColor: 'rgba(0, 168, 255, 0.3)',
                            borderWidth: 1,
                            padding: 10,
                            cornerRadius: 5
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            title: {
                                display: true,
                                text: '电压 (V)',
                                color: '#00a8ff'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            title: {
                                display: true,
                                text: '功率 (W)',
                                color: '#ffa502'
                            }
                        }
                    }
                }
            });

            // 电池数据图表
            const batteryChartCtx = document.getElementById('batteryChart').getContext('2d');
            batteryChart = new Chart(batteryChartCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '电压 (V)',
                            data: [],
                            borderColor: '#00a8ff',
                            backgroundColor: 'rgba(0, 168, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: '容量 (%)',
                            data: [],
                            borderColor: '#4cd137',
                            backgroundColor: 'rgba(76, 209, 55, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(13, 28, 75, 0.9)',
                            borderColor: 'rgba(0, 168, 255, 0.3)',
                            borderWidth: 1,
                            padding: 10,
                            cornerRadius: 5
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            title: {
                                display: true,
                                text: '电压 (V)',
                                color: '#00a8ff'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            title: {
                                display: true,
                                text: '容量 (%)',
                                color: '#4cd137'
                            },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
            
            // 太阳能数据图表
            const solarChartCtx = document.getElementById('solarChart').getContext('2d');
            solarChart = new Chart(solarChartCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '电压 (V)',
                            data: [],
                            borderColor: '#00a8ff',
                            backgroundColor: 'rgba(0, 168, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: '电流 (A)',
                            data: [],
                            borderColor: '#ff9f43',
                            backgroundColor: 'rgba(255, 159, 67, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        },
                        {
                            label: '功率 (W)',
                            data: [],
                            borderColor: '#ffa502',
                            backgroundColor: 'rgba(255, 165, 2, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(13, 28, 75, 0.9)',
                            borderColor: 'rgba(0, 168, 255, 0.3)',
                            borderWidth: 1,
                            padding: 10,
                            cornerRadius: 5
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            title: {
                                display: true,
                                text: '电压 (V)',
                                color: '#00a8ff'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            title: {
                                display: true,
                                text: '电流 (A)',
                                color: '#ff9f43'
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            title: {
                                display: true,
                                text: '功率 (W)',
                                color: '#ffa502'
                            }
                        }
                    }
                }
            });
        }
        
        // 格式化时间
        function formatTime(timestamp) {
            try {
                // 确保timestamp是有效数据
                if (!timestamp) {
                    console.error('时间戳为空');
                    return new Date().toLocaleString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                }
                
                let date;
                
                // 处理Date对象
                if (timestamp instanceof Date) {
                    date = timestamp;
                }
                // 处理字符串时间戳
                else if (typeof timestamp === 'string') {
                    // 检查是否已经是格式化的时间字符串
                    if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(timestamp)) {
                        return timestamp;
                    }
                    
                    // 处理ISO格式的时间字符串
                    const cleanTimestamp = timestamp.replace('T', ' ').replace(/\.\d+Z$/, '');
                    date = new Date(cleanTimestamp);
                    
                    // 如果Date无效，尝试其他格式
                    if (isNaN(date.getTime())) {
                        // 尝试处理其他常见格式
                        const formats = [
                            timestamp, // 原始格式
                            cleanTimestamp, // 清理后的格式
                            timestamp.replace(/Z$/, '') // 去掉Z后缀
                        ];
                        
                        for (const format of formats) {
                            date = new Date(format);
                            if (!isNaN(date.getTime())) break;
                        }
                    }
                }
                // 处理数字时间戳（毫秒）
                else if (typeof timestamp === 'number') {
                    date = new Date(timestamp);
                }
                
                // 检查日期是否有效
                if (!date || isNaN(date.getTime())) {
                    console.error('无法解析的时间戳:', timestamp);
                    // 返回当前时间作为后备
                    date = new Date();
                }
                
                // 输出调试信息
                console.debug('时间戳:', timestamp, '解析后:', date.toISOString());
                
                // 使用本地时区显示时间
                return date.toLocaleString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            } catch (e) {
                console.error('格式化时间出错:', e, 'timestamp:', timestamp);
                return new Date().toLocaleString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            }
        }
        
        // 格式化日期时间
        function formatDateTime(dateTimeStr) {
            try {
                // 尝试修复常见时间格式问题
                if (typeof dateTimeStr === 'string') {
                    // 处理ISO格式的时间字符串
                    dateTimeStr = dateTimeStr.replace('T', ' ').replace(/\.\d+Z$/, '');
                }
                
                const date = new Date(dateTimeStr);
                
                // 检查日期是否有效
                if (isNaN(date.getTime())) {
                    console.error('无效的日期时间字符串:', dateTimeStr);
                    return '时间未知';
                }
                
                // 使用本地化格式显示日期时间
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            } catch (e) {
                console.error('格式化日期时间出错:', e);
                return '时间未知';
            }
        }
        
        // 用于存储上一次电池容量值，用于计算趋势
        let lastBatteryCapacity = null;
        
        // 更新电池状态
        function updateBatteryStatus(data) {
            if (!data) return;
            
            // 添加动画效果
            batteryVoltageElement.classList.add('pulse');
            
            // 更新数据
            batteryVoltageElement.textContent = data.voltage.toFixed(2);
            batteryPercentageElement.textContent = `${data.capacity.toFixed(0)}%`;
            batteryLevelElement.style.width = `${data.capacity}%`;
            
            // 根据电量百分比确定电池状态
            let status = '正常';
            
            if (data.capacity >= 90) {
                status = '满电';
            } else if (data.capacity <= 20) {
                status = '电量低';
            } else {
                // 如果有趋势数据，根据电量变化趋势决定状态
                if (data.trend > 0) {
                    status = '充电中';
                } else if (data.trend < 0) {
                    status = '放电中';
                } else {
                    status = '正常';
                }
            }
            
            // 更新电池状态
            batteryStatusElement.textContent = status;
            batteryStatusElement.className = 'status-indicator';
            
            // 根据状态添加相应的CSS类
            if (status === '充电中') {
                batteryStatusElement.classList.add('charging');
            } else if (status === '放电中') {
                batteryStatusElement.classList.add('discharging');
            } else if (status === '满电') {
                batteryStatusElement.classList.add('full');
            } else if (status === '电量低') {
                batteryStatusElement.classList.add('discharging');
            } else {
                batteryStatusElement.classList.add('charging');
            }
            
            // 移除动画效果
            setTimeout(() => {
                batteryVoltageElement.classList.remove('pulse');
            }, 2000);
            
            // 更新图表数据
            updateBatteryChart(data);
            
            // 添加数据到表格
            addDataToTable({...data, status}, batteryTableBody, 'battery');
            
            // 更新能源图表（只传递电池数据）
            updateEnergyChart(data, null, null);
        }
        
        // 更新太阳能板状态
        function updateSolarStatus(data) {
            if (!data) return;
            
            // 添加动画效果
            solarPowerElement.classList.add('pulse');
            
            // 更新数据
            solarPowerElement.textContent = data.power.toFixed(1);
            solarVoltageElement.textContent = `电压: ${data.voltage.toFixed(1)}V`;
            solarCurrentElement.textContent = `电流: ${data.current.toFixed(2)}A`;
            solarEfficiencyElement.textContent = `效率: ${data.efficiency.toFixed(1)}%`;
            
            // 移除动画效果
            setTimeout(() => {
                solarPowerElement.classList.remove('pulse');
            }, 2000);
            
            // 更新图表数据
            updateSolarChart(data);
            
            // 添加数据到表格
            addDataToTable(data, solarTableBody, 'solar');
            
            // 更新能源图表（只传递太阳能数据）
            updateEnergyChart(null, data, null);
        }
        
        // 更新系统供电状态
        function updateSystemStatus(data) {
            if (!data) return;
            
            // 添加动画效果
            loadPowerElement.classList.add('pulse');
            
            // 更新数据
            loadPowerElement.textContent = data.load_power.toFixed(1);
            
            // 更新供电来源状态
            if (data.source === '太阳能') {
                solarPowerStatusElement.classList.add('active');
                solarPowerStatusElement.classList.remove('inactive');
                gridPowerStatusElement.classList.add('inactive');
                gridPowerStatusElement.classList.remove('active');
            } else {
                gridPowerStatusElement.classList.add('active');
                gridPowerStatusElement.classList.remove('inactive');
                solarPowerStatusElement.classList.add('inactive');
                solarPowerStatusElement.classList.remove('active');
            }
            
            // 更新状态文本
            solarStatusTextElement.textContent = data.solar_status;
            gridStatusTextElement.textContent = data.grid_status;
            
            // 移除动画效果
            setTimeout(() => {
                loadPowerElement.classList.remove('pulse');
            }, 2000);
            
            // 添加数据到表格
            addDataToTable(data, powerTableBody, 'power');
            
            // 更新能源图表（只传递系统负载数据）
            updateEnergyChart(null, null, data);
        }
        
        // 更新天气数据
        function updateWeatherData(weatherData) {
            if (!weatherData) return;
            
            console.log('收到天气数据，详细信息:', JSON.stringify(weatherData, null, 2));
            
            // 处理嵌套的数据结构
            // 如果天气数据是嵌套在weather属性中的，则提取出来
            if (weatherData.weather && typeof weatherData.weather === 'object') {
                console.log('检测到嵌套的天气数据结构，提取内部weather对象');
                weatherData = weatherData.weather;
            }
            
            // 保存天气数据源信息，用于诊断
            const source = weatherData.source || '未知来源';
            const isReal = weatherData.isReal === true;
            const priority = weatherData.priority || 'normal';

            console.log(`处理天气数据: 来源=${source}, 是否真实API数据=${isReal}, 优先级=${priority}`);
            
            const temperatureElement = document.getElementById('weather-temperature');
            const conditionElement = document.getElementById('weather-condition');
            const weatherIconElement = document.getElementById('weather-icon');
            const weatherSourceElement = document.getElementById('weather-source');
            
            // 确保有有效的温度数据
            let temperature = weatherData.temperature;
            if (temperature === undefined || temperature === null || temperature === '') {
                temperature = 25 + Math.random() * 5; // 如果没有温度数据，生成一个合理的默认值
            }
            
            // 确保温度是数字类型
            if (typeof temperature === 'string') {
                temperature = parseFloat(temperature);
            }
            
            // 确保有有效的天气状况 - 优先使用API返回的真实天气
            let condition = weatherData.condition || weatherData.weather || weatherData.weather_condition || '未知';
            
            // 特别处理：如果来源是实际API且有isReal标记，优先使用其提供的天气状况
            if (isReal || source.includes('API')) {
                console.log('使用真实API返回的天气状况:', condition);
                // 更新本地缓存，记录最后一次API数据
                localStorage.setItem('lastApiWeatherData', JSON.stringify({
                    condition: condition,
                    temperature: temperature,
                    timestamp: new Date().toISOString(),
                    source: source
                }));
            } else if (!condition || condition === '未知') {
                // 如果没有天气状况，尝试使用缓存的API数据
                try {
                    const cachedWeather = JSON.parse(localStorage.getItem('lastApiWeatherData'));
                    if (cachedWeather && cachedWeather.condition) {
                        condition = cachedWeather.condition;
                        console.log('使用缓存的API天气状况:', condition);
                    } else {
                        condition = '晴';
                        console.log('无缓存API数据，使用默认天气状况:', condition);
                    }
                } catch (e) {
                    condition = '晴';
                    console.log('无法解析缓存数据，使用默认天气状况:', condition);
                }
            }
            
            // 更新页面显示
            if (temperatureElement) {
                // 确保温度数据的格式是"xx.x°C"
                temperatureElement.textContent = temperature.toFixed(1) + '°C';
            }
            
            if (conditionElement) {
                conditionElement.textContent = condition;
                
                // 根据条件添加相应的CSS类
                conditionElement.className = '';
                if (condition.includes('晴')) {
                    conditionElement.classList.add('sunny');
                } else if (condition.includes('雨')) {
                    conditionElement.classList.add('rainy');
                } else if (condition.includes('云') || condition.includes('多云')) {
                    conditionElement.classList.add('cloudy');
                } else if (condition.includes('霾')) {
                    conditionElement.classList.add('haze');
                }
            }
            
            // 根据天气状况设置图标 - 优化图标选择逻辑
            if (weatherIconElement) {
                weatherIconElement.innerHTML = ''; // 清空现有图标
                
                let iconClass = 'fas fa-sun'; // 默认图标
                
                // 严格匹配条件以避免错误
                if (condition.includes('多云')) {
                    iconClass = 'fas fa-cloud-sun';
                } else if (condition.includes('阴')) {
                    iconClass = 'fas fa-cloud';
                } else if (condition.includes('雷')) {
                    iconClass = 'fas fa-bolt';
                } else if (condition.includes('暴雨') || condition.includes('大雨')) {
                    iconClass = 'fas fa-cloud-showers-heavy';
                } else if (condition.includes('雨')) {
                    iconClass = 'fas fa-cloud-rain';
                } else if (condition.includes('雪')) {
                    iconClass = 'fas fa-snowflake';
                } else if (condition.includes('雾') || condition.includes('霾')) {
                    iconClass = 'fas fa-smog';
                } else if (condition.includes('晴') || condition === '晴朗') {
                    iconClass = 'fas fa-sun';
                }
                
                // 创建新的图标元素
                const iconElement = document.createElement('i');
                iconElement.className = iconClass;
                weatherIconElement.appendChild(iconElement);
                
                console.log('设置天气图标为:', iconClass, '基于天气状况:', condition);
            }
            
            // 显示数据来源 - 确保显示准确的数据来源
            if (weatherSourceElement) {
                weatherSourceElement.textContent = '(心知天气API)';
                console.log('天气数据来源设置为心知天气API');
            }
            
            // 添加数据到表格
            if (weatherTableBody) {
                const tableData = {
                    temperature: temperature,
                    condition: condition,
                    timestamp: weatherData.timestamp || new Date().toISOString()
                };
                addDataToTable(tableData, weatherTableBody, 'weather');
            }
        }
        
        // 更新电价信息
        function updatePriceStatus(data) {
            if (!data) {
                console.error('updatePriceStatus: 收到空数据');
                return;
            }
            
            console.log('更新电价信息:', JSON.stringify(data));
            
            // 添加动画效果
            electricityPriceElement.classList.add('pulse');
            
            // 检查电价数据是否无效
            let price = 0;
            if (typeof data.price === 'number' && data.price > 0) {
                // 直接是数字
                price = data.price;
            } else if (data.price && typeof data.price.price === 'number' && data.price.price > 0) {
                // 嵌套对象
                price = data.price.price;
            } else if (data.current && typeof data.current === 'number' && data.current > 0) {
                // 兼容其他字段名
                price = data.current;
            } else {
                // 数据无效，使用默认值或最近一次有效值
                const lastValidPrice = localStorage.getItem('lastValidPrice');
                if (lastValidPrice) {
                    price = parseFloat(lastValidPrice);
                    console.log('使用缓存的最近有效电价:', price);
                } else {
                    // 根据时间生成合理的默认电价
                    const hour = new Date().getHours();
                    if ((hour >= 8 && hour < 12) || (hour >= 17 && hour < 21)) {
                        price = 0.82; // 峰值电价
                    } else if (hour >= 23 || hour < 7) {
                        price = 0.32; // 谷值电价
                    } else {
                        price = 0.55; // 平值电价
                    }
                    console.log('使用默认电价:', price);
                }
            }
            
            // 检查价格等级
            let priceLevel = '普通';
            if (data.price_level) {
                priceLevel = data.price_level;
            } else if (data.price && data.price.price_level) {
                priceLevel = data.price.price_level;
            } else if (data.level) {
                priceLevel = data.level;
            } else {
                // 根据电价值判断等级
                if (price >= 0.7) priceLevel = '峰值';
                else if (price <= 0.4) priceLevel = '谷值';
                else priceLevel = '平值';
            }
            
            // 检查下次变动时间
            let nextChangeTime;
            if (data.next_change_time) {
                nextChangeTime = data.next_change_time;
            } else if (data.price && data.price.next_change_time) {
                nextChangeTime = data.price.next_change_time;
            } else if (data.nextChange) {
                nextChangeTime = data.nextChange;
            } else if (data.nextChangeTime) {
                nextChangeTime = data.nextChangeTime;
            } else {
                // 生成默认的下次变动时间
                const now = new Date();
                const hour = now.getHours();
                const nextHour = new Date(now);
                
                // 根据当前时间段确定下一个变动时间点
                let nextH;
                if (hour < 7) nextH = 7;
                else if (hour < 8) nextH = 8;
                else if (hour < 12) nextH = 12;
                else if (hour < 17) nextH = 17;
                else if (hour < 21) nextH = 21;
                else if (hour < 23) nextH = 23;
                else nextH = 7; // 跨天
                
                if (hour >= 23 && nextH < 23) {
                    nextHour.setDate(nextHour.getDate() + 1);
                }
                nextHour.setHours(nextH, 0, 0, 0);
                nextChangeTime = nextHour.toISOString();
            }
            
            // 保存有效的电价值以供未来使用
            if (price > 0) {
                localStorage.setItem('lastValidPrice', price.toString());
            }
            
            // 更新DOM显示
            electricityPriceElement.textContent = price.toFixed(2);
            
            // 更新价格等级状态
            priceLevelElement.textContent = priceLevel;
            priceLevelElement.className = 'price-level';
            
            if (priceLevel.includes('峰')) {
                priceLevelElement.classList.add('peak');
            } else if (priceLevel.includes('平')) {
                priceLevelElement.classList.add('normal');
            } else if (priceLevel.includes('谷')) {
                priceLevelElement.classList.add('valley');
            }
            
            // 更新下次价格变动时间
            try {
                const nextChange = new Date(nextChangeTime);
                nextPriceChangeElement.textContent = `下次变动: ${nextChange.toLocaleString('zh-CN')}`;
            } catch (error) {
                console.error('处理下次价格变动时间出错:', error);
                nextPriceChangeElement.textContent = '下次变动: 未知';
            }
            
            // 移除动画效果
            setTimeout(() => {
                electricityPriceElement.classList.remove('pulse');
            }, 2000);
            
            // 添加电价数据到表格
            const priceData = {
                price: price,
                price_level: priceLevel,
                next_change_time: nextChangeTime,
                timestamp: data.timestamp || new Date().toISOString()
            };
            
            addDataToTable(priceData, priceTableBody, 'price');
        }
        
        // 更新所有数据
        function updateAllData(data) {
            if (!data) return;
            
            try {
                // 电池数据处理
                // 支持嵌套对象和扁平结构
                const batteryData = data.battery || {};
                const batteryInfo = {
                    voltage: data.batteryVoltage || batteryData.voltage || 0,
                    capacity: data.batteryCapacity || batteryData.capacity || 0,
                    status: data.batteryStatus || batteryData.status || '未知',
                    temperature: data.batteryTemperature || batteryData.temperature || 0,
                    timestamp: data.timestamp || batteryData.timestamp || new Date().toISOString()
                };
                updateBatteryStatus(batteryInfo);
                
                // 太阳能数据处理
                const solarData = data.solar || {};
                const solarInfo = {
                    voltage: data.solarVoltage || solarData.voltage || 0,
                    current: data.solarCurrent || solarData.current || 0,
                    power: data.solarPower || solarData.power || 0,
                    efficiency: data.solarEfficiency || solarData.efficiency || 0,
                    timestamp: data.timestamp || solarData.timestamp || new Date().toISOString()
                };
                updateSolarStatus(solarInfo);
                
                // 电网状态数据处理
                const systemData = data.system || data.powerStatus || {};
                const systemInfo = {
                    source: data.energySource || systemData.source || '未知',
                    load_power: data.loadPower || systemData.load_power || systemData.loadPower || 0,
                    solar_status: data.solarStatus || systemData.solar_status || systemData.solarStatus || '未知',
                    grid_status: data.gridStatus || systemData.grid_status || systemData.gridStatus || '未知',
                    timestamp: data.timestamp || systemData.timestamp || new Date().toISOString()
                };
                updateSystemStatus(systemInfo);
                
                // 天气数据处理
                const weatherData = data.weather || {};
                const weatherInfo = {
                    temperature: data.temperature || weatherData.temperature || 0,
                    condition: data.weatherCondition || weatherData.condition || weatherData.weather_condition || '未知',
                    timestamp: data.timestamp || weatherData.timestamp || new Date().toISOString()
                };
                updateWeatherData(weatherInfo);
                
                // 电价数据处理
                const priceData = data.price || {};
                const priceInfo = {
                    price: data.price || priceData.price || priceData.current || 0,
                    price_level: data.priceLevel || priceData.price_level || priceData.level || '普通',
                    next_change_time: data.nextChangeTime || priceData.next_change_time || priceData.nextChange || new Date().toISOString(),
                    timestamp: data.timestamp || priceData.timestamp || new Date().toISOString()
                };
                updatePriceStatus(priceInfo);
                
                // 直接更新能源图表，传递所有三种数据
                updateEnergyChart(batteryInfo, solarInfo, systemInfo);
            } catch (error) {
                console.error('更新数据时出错:', error);
            }
        }
        
        // 添加数据到表格
        function addDataToTable(data, tableBody, type) {
            // 确保表格和数据都存在
            if (!data || !tableBody) return;
            
            try {
                const row = document.createElement('tr');
                
                // 确保数据中必需的字段存在
                const timestamp = data.timestamp || new Date().toISOString();
                
                switch (type) {
                    case 'battery':
                        // 检查必要的数据
                        const voltage = isNaN(data.voltage) ? 0 : data.voltage;
                        const capacity = isNaN(data.capacity) ? 0 : data.capacity;
                        const status = data.status || '未知';
                        
                        row.innerHTML = `
                            <td>${formatTime(timestamp)}</td>
                            <td>${voltage.toFixed(2)}</td>
                            <td>${capacity.toFixed(1)}</td>
                            <td>${status}</td>
                        `;
                        break;
                    case 'solar':
                        // 检查必要的数据
                        const solarVoltage = isNaN(data.voltage) ? 0 : data.voltage;
                        const current = isNaN(data.current) ? 0 : data.current;
                        const power = isNaN(data.power) ? 0 : data.power;
                        
                        row.innerHTML = `
                            <td>${formatTime(timestamp)}</td>
                            <td>${solarVoltage.toFixed(2)}</td>
                            <td>${current.toFixed(2)}</td>
                            <td>${power.toFixed(1)}</td>
                        `;
                        break;
                    case 'power':
                        // 检查必要的数据
                        const source = data.source || '未知';
                        const gridStatus = data.grid_status || '未知';
                        const solarStatus = data.solar_status || '未知';
                        const loadPower = isNaN(data.load_power) ? 0 : data.load_power;
                        
                        row.innerHTML = `
                            <td>${formatTime(timestamp)}</td>
                            <td>${source}</td>
                            <td>${gridStatus}</td>
                            <td>${solarStatus}</td>
                            <td>${loadPower.toFixed(1)}</td>
                        `;
                        break;
                    case 'weather':
                        // 检查必要的数据
                        const temperature = isNaN(data.temperature) ? 0 : data.temperature;
                        const weatherCondition = data.weather_condition || data.condition || data.weather || '未知';
                        
                        row.innerHTML = `
                            <td>${formatTime(timestamp)}</td>
                            <td>${temperature.toFixed(1)}</td>
                            <td>${weatherCondition}</td>
                        `;
                        break;
                    case 'price':
                        // 检查必要的数据
                        const price = isNaN(data.price) ? 0 : data.price;
                        const priceLevel = data.price_level || '普通';
                        const nextChangeTime = data.next_change_time || new Date().toISOString();
                        
                        row.innerHTML = `
                            <td>${formatTime(timestamp)}</td>
                            <td>${price.toFixed(2)}</td>
                            <td>${priceLevel}</td>
                            <td>${formatDateTime(nextChangeTime)}</td>
                        `;
                        break;
                }
                
                // 添加行动画
                row.style.opacity = '0';
                row.style.transform = 'translateY(-10px)';
                row.style.transition = 'all 0.3s ease';
                
                // 限制表格行数
                if (tableBody.children.length >= 10) {
                    tableBody.removeChild(tableBody.lastChild);
                }
                
                tableBody.insertBefore(row, tableBody.firstChild);
                
                // 触发动画
                setTimeout(() => {
                    row.style.opacity = '1';
                    row.style.transform = 'translateY(0)';
                }, 10);
            } catch (error) {
                console.error('添加数据到表格时出错:', error, '数据:', data);
            }
        }
        
        // 监听 Socket.IO 事件
        socket.on('connect', () => {
            console.log('已连接到服务器');
            // 只有当connectionStatus元素存在时才更新
            if (connectionStatus) {
                connectionStatus.textContent = '已连接';
                connectionStatus.className = 'status online';
            }
        });
        
        socket.on('disconnect', () => {
            console.log('与服务器断开连接');
            // 只有当connectionStatus元素存在时才更新
            if (connectionStatus) {
                connectionStatus.textContent = '已断开';
                connectionStatus.className = 'status offline';
            }
        });
        
        // 处理从阿里云接收的设备数据
        socket.on('device-data', (data) => {
            console.log('收到device-data事件数据:', Object.keys(data).join(', '));
            
            // 特殊处理天气数据
            if (data.weather) {
                // 检查是否为API真实数据
                const isApiData = data.weather.isReal === true || 
                                 (data.weather.source && 
                                  (data.weather.source.includes('API') || 
                                   data.weather.source.includes('天气')));
                
                // 检查优先级
                const isHighPriority = data.priority === 'high' || 
                                      data.weather.priority === 'high';
                
                console.log(`天气数据来源: ${data.weather.source || '未知'}, 是否API数据: ${isApiData}, 优先级: ${isHighPriority ? '高' : '低'}`);
                
                // 如果是API数据或高优先级，直接更新
                if (isApiData || isHighPriority) {
                    console.log('处理高优先级/API天气数据');
                    
                    // 确保天气数据字段格式正确
                    const weatherForUpdate = {
                        temperature: data.weather.temperature,
                        condition: data.weather.condition || data.weather.weather || data.weather.weather_condition,
                        source: data.weather.source || '心知天气API',
                        isReal: true, 
                        priority: 'high',
                        timestamp: data.weather.timestamp || data.timestamp || new Date().toISOString()
                    };
                    
                    // 保存最后一次API天气数据
                    localStorage.setItem('lastApiWeatherData', JSON.stringify(weatherForUpdate));
                    localStorage.setItem('lastApiWeatherTime', new Date().getTime().toString());
                    
                    // 更新UI
                    updateWeatherData(weatherForUpdate);
                } else {
                    // 如果是低优先级模拟数据，检查是否有最近的API数据
                    const lastApiTime = localStorage.getItem('lastApiWeatherTime');
                    const now = new Date().getTime();
                    
                    // 如果30分钟内有API数据，优先使用API数据
                    if (lastApiTime && (now - parseInt(lastApiTime) < 30 * 60 * 1000)) {
                        try {
                            const apiData = JSON.parse(localStorage.getItem('lastApiWeatherData'));
                            if (apiData && apiData.condition) {
                                console.log('使用缓存的API天气数据，忽略模拟数据');
                                updateWeatherData(apiData);
                                return;
                            }
                        } catch (e) {
                            console.error('解析缓存的API天气数据失败:', e);
                        }
                    }
                    
                    // 没有近期API数据时，使用模拟数据
                    console.log('使用模拟天气数据');
                    updateWeatherData(data.weather);
                }
            }
            
            // 使用更新后的updateAllData函数处理数据，它支持嵌套和扁平结构
            updateAllData(data);
            
            // 添加数据到对应表格
            try {
                // 处理电池数据
                const batteryData = {
                    voltage: data.batteryVoltage || (data.battery && data.battery.voltage) || 0,
                    capacity: data.batteryCapacity || (data.battery && data.battery.capacity) || 0,
                    status: data.batteryStatus || (data.battery && data.battery.status) || '未知',
                    timestamp: data.timestamp || new Date().toISOString()
                };
                
                // 处理太阳能数据
                const solarData = {
                    voltage: data.solarVoltage || (data.solar && data.solar.voltage) || 0,
                    current: data.solarCurrent || (data.solar && data.solar.current) || 0,
                    power: data.solarPower || (data.solar && data.solar.power) || 0,
                    timestamp: data.timestamp || new Date().toISOString()
                };
                
                // 处理系统数据
                const powerData = {
                    source: data.energySource || (data.system && data.system.source) || '未知',
                    grid_status: data.gridStatus || (data.system && data.system.gridStatus) || '未知',
                    solar_status: data.solarStatus || (data.system && data.system.solarStatus) || '未知',
                    load_power: data.loadPower || (data.system && data.system.loadPower) || 0,
                    timestamp: data.timestamp || new Date().toISOString()
                };
                
                // 天气数据在上面已经处理，这里只添加到表格
                if (data.weather) {
                    const weatherData = {
                        temperature: data.weather.temperature || 0,
                        weather_condition: data.weather.condition || data.weather.weather || data.weather.weather_condition || '未知',
                        timestamp: data.weather.timestamp || data.timestamp || new Date().toISOString(),
                        source: data.weather.source || '未知来源'
                    };
                    addDataToTable(weatherData, weatherTableBody, 'weather');
                }
                
                // 处理电价数据
                const priceData = {
                    price: data.price || (data.price && data.price.current) || 0,
                    price_level: data.priceLevel || (data.price && data.price.level) || '普通',
                    next_change_time: data.nextChangeTime || (data.price && data.price.nextChange) || new Date().toISOString(),
                    timestamp: data.timestamp || new Date().toISOString()
                };
                
                // 添加到表格
                addDataToTable(batteryData, batteryTableBody, 'battery');
                addDataToTable(solarData, solarTableBody, 'solar');
                addDataToTable(powerData, powerTableBody, 'power');
                addDataToTable(priceData, priceTableBody, 'price');
            } catch (error) {
                console.error('处理设备数据时出错:', error);
            }
        });
        
        // 接收专门的天气数据
        socket.on('weather-data', (data) => {
            console.log('收到实时天气数据:', data);
            if (data && data.weather) {
                // 标记为高优先级API数据
                const apiWeather = {
                    ...data.weather,
                    isReal: true,
                    priority: 'high',
                    source: data.weather.source || '心知天气API',
                    timestamp: data.timestamp || new Date().toISOString()
                };
                
                console.log('处理高优先级API天气数据:', apiWeather.condition || apiWeather.weather);
                
                // 保存到本地存储，供其他事件参考
                localStorage.setItem('lastApiWeatherData', JSON.stringify(apiWeather));
                localStorage.setItem('lastApiWeatherTime', new Date().getTime().toString());
                
                // 更新UI
                updateWeatherData(apiWeather);
            }
        });
        
        socket.on('data-update', (data) => {
            console.log('收到数据更新:', data);
            
            try {
                // 使用更新后的updateAllData函数处理数据，它支持嵌套和扁平结构
                updateAllData(data);
                
                // 处理电池数据
                const batteryData = {
                    voltage: data.batteryVoltage || (data.battery && data.battery.voltage) || 0,
                    capacity: data.batteryCapacity || (data.battery && data.battery.capacity) || 0,
                    status: data.batteryStatus || (data.battery && data.battery.status) || '未知',
                    timestamp: data.timestamp || new Date().toISOString()
                };
                
                // 处理太阳能数据
                const solarData = {
                    voltage: data.solarVoltage || (data.solar && data.solar.voltage) || 0,
                    current: data.solarCurrent || (data.solar && data.solar.current) || 0,
                    power: data.solarPower || (data.solar && data.solar.power) || 0,
                    timestamp: data.timestamp || new Date().toISOString()
                };
                
                // 处理系统数据
                const powerData = {
                    source: data.energySource || (data.system && data.system.source) || '未知',
                    grid_status: data.gridStatus || (data.system && data.system.gridStatus) || '未知',
                    solar_status: data.solarStatus || (data.system && data.system.solarStatus) || '未知',
                    load_power: data.loadPower || (data.system && data.system.loadPower) || 0,
                    timestamp: data.timestamp || new Date().toISOString()
                };
                
                // 处理天气数据
                const weatherData = {
                    temperature: data.temperature || (data.weather && data.weather.temperature) || 0,
                    weather_condition: data.weatherCondition || (data.weather && (data.weather.condition || data.weather.weather_condition)) || '未知',
                    timestamp: data.timestamp || new Date().toISOString()
                };
                
                // 处理电价数据
                const priceData = {
                    price: data.price || (data.price && data.price.current) || 0,
                    price_level: data.priceLevel || (data.price && data.price.level) || '普通',
                    next_change_time: data.nextChangeTime || (data.price && data.price.nextChange) || new Date().toISOString(),
                    timestamp: data.timestamp || new Date().toISOString()
                };
                
                // 添加到表格
                if (data.battery || data.batteryVoltage) addDataToTable(batteryData, batteryTableBody, 'battery');
                if (data.solar || data.solarVoltage) addDataToTable(solarData, solarTableBody, 'solar');
                if (data.system || data.energySource) addDataToTable(powerData, powerTableBody, 'power');
                if (data.weather || data.temperature) addDataToTable(weatherData, weatherTableBody, 'weather');
                if (data.price || data.priceLevel) addDataToTable(priceData, priceTableBody, 'price');
            } catch (error) {
                console.error('处理数据更新时出错:', error);
            }
        });
        
        // 页面加载时获取历史数据
        window.addEventListener('load', function() {
            // 添加加载动画
            const loadingElement = document.createElement('div');
            loadingElement.style.position = 'fixed';
            loadingElement.style.top = '0';
            loadingElement.style.left = '0';
            loadingElement.style.width = '100%';
            loadingElement.style.height = '100%';
            loadingElement.style.backgroundColor = 'rgba(6, 13, 44, 0.9)';
            loadingElement.style.display = 'flex';
            loadingElement.style.justifyContent = 'center';
            loadingElement.style.alignItems = 'center';
            loadingElement.style.zIndex = '9999';
            loadingElement.style.transition = 'opacity 0.5s ease';
            loadingElement.innerHTML = '<div style="color: #00a8ff; font-size: 1.5rem;">加载数据中...</div>';
            document.body.appendChild(loadingElement);
            
            // 延迟一秒，模拟加载过程
            setTimeout(function() {
                // 移除加载动画
                loadingElement.style.opacity = '0';
                setTimeout(function() {
                    document.body.removeChild(loadingElement);
                }, 500);
            }, 1000);
            
            // 获取湖北省实时电价
            fetch('/api/hubei-electricity-price')
                .then(response => response.json())
                .then(data => {
                    console.log('获取湖北省实时电价', data);
                    updatePriceStatus(data);
                })
                .catch(error => {
                    console.error('获取湖北省实时电价时出错:', error);
                });
            
            // 获取武汉实时天气
            fetch('/api/wuhan-weather')
                .then(response => response.json())
                .then(data => {
                    console.log('获取武汉实时天气:', data);
                    updateWeatherData(data);
                })
                .catch(error => {
                    console.error('获取武汉实时天气时出错:', error);
                });
            
            // 获取所有最新数据
            fetch('/api/all-latest-data')
                .then(response => response.json())
                .then(data => {
                    console.log('获取最新数据', data);
                    updateAllData(data);
                })
                .catch(error => {
                    console.error('获取最新数据时出错:', error);
                    // 只有当connectionStatus元素存在时才更新
                    if (connectionStatus) {
                        connectionStatus.textContent = '数据加载失败';
                        connectionStatus.className = 'status offline';
                    }
                });
            
            // 获取历史数据
            Promise.all([
                fetch('/api/battery-data').then(res => res.json()),
                fetch('/api/solar-data').then(res => res.json()),
                fetch('/api/power-status').then(res => res.json()),
                fetch('/api/weather-data').then(res => res.json()),
                fetch('/api/electricity-price').then(res => res.json()),
                fetch('/api/energy-data').then(res => res.json())
            ])
            .then(([batteryData, solarData, powerData, weatherData, priceData, energyData]) => {
                console.log('获取历史数据成功');
                
                // 填充表格数据
                if (batteryTableBody) batteryTableBody.innerHTML = '';
                if (solarTableBody) solarTableBody.innerHTML = '';
                if (powerTableBody) powerTableBody.innerHTML = '';
                if (weatherTableBody) weatherTableBody.innerHTML = '';
                if (priceTableBody) priceTableBody.innerHTML = '';
                
                if (batteryData && batteryData.length > 0 && batteryTableBody) {
                    // 为历史电池数据计算趋势
                    let prevCapacity = null;
                    
                    // 添加趋势数据到电池历史记录
                    batteryData = batteryData.map(item => {
                        // 计算趋势
                        let trend = 0;
                        if (prevCapacity !== null) {
                            if (item.capacity > prevCapacity) {
                                trend = 1;
                            } else if (item.capacity < prevCapacity) {
                                trend = -1;
                            }
                        }
                        prevCapacity = item.capacity;
                        
                        // 返回添加了趋势的数据
                        return {...item, trend};
                    });
                    
                    batteryData.slice(0, 10).forEach(item => {
                        addDataToTable(item, batteryTableBody, 'battery');
                    });
                }
                
                if (solarData && solarData.length > 0 && solarTableBody) {
                    solarData.slice(0, 10).forEach(item => {
                        addDataToTable(item, solarTableBody, 'solar');
                    });
                }
                
                if (powerData && powerData.length > 0 && powerTableBody) {
                    powerData.slice(0, 10).forEach(item => {
                        addDataToTable(item, powerTableBody, 'power');
                    });
                }
                
                if (weatherData && weatherData.length > 0 && weatherTableBody) {
                    weatherData.slice(0, 10).forEach(item => {
                        addDataToTable(item, weatherTableBody, 'weather');
                    });
                }
                
                if (priceData && priceData.length > 0 && priceTableBody) {
                    priceData.slice(0, 10).forEach(item => {
                        addDataToTable(item, priceTableBody, 'price');
                    });
                }
                
                // 填充图表数据
                if (batteryData && batteryData.length > 0) {
                    console.log('处理并同步历史数据...');
                    
                    // 获取所有时间戳并合并
                    let allTimestamps = [];
                    
                    // 添加电池数据的时间戳
                    if (batteryData && batteryData.length > 0) {
                        batteryData.forEach(item => {
                            if (item.timestamp) {
                                allTimestamps.push(formatTime(item.timestamp));
                            }
                        });
                    }
                    
                    // 添加太阳能数据的时间戳
                    if (solarData && solarData.length > 0) {
                        solarData.forEach(item => {
                            if (item.timestamp) {
                                allTimestamps.push(formatTime(item.timestamp));
                            }
                        });
                    }
                    
                    // 添加电网状态数据的时间戳
                    if (powerData && powerData.length > 0) {
                        powerData.forEach(item => {
                            if (item.timestamp) {
                                allTimestamps.push(formatTime(item.timestamp));
                            }
                        });
                    }
                    
                    // 去重并排序所有时间戳
                    allTimestamps = [...new Set(allTimestamps)].sort();
                    
                    // 如果时间戳超过20个，只保留最新的20个
                    if (allTimestamps.length > 20) {
                        allTimestamps = allTimestamps.slice(allTimestamps.length - 20);
                    }
                    
                    console.log(`找到${allTimestamps.length}个唯一时间点`);
                    
                    // 为每种数据创建查找映射
                    const batteryMap = {};
                    batteryData.forEach(item => {
                        if (item.timestamp) {
                            batteryMap[formatTime(item.timestamp)] = item;
                        }
                    });
                    
                    const solarMap = {};
                    if (solarData && solarData.length > 0) {
                        solarData.forEach(item => {
                            if (item.timestamp) {
                                solarMap[formatTime(item.timestamp)] = item;
                            }
                        });
                    }
                    
                    const powerMap = {};
                    if (powerData && powerData.length > 0) {
                        powerData.forEach(item => {
                            if (item.timestamp) {
                                powerMap[formatTime(item.timestamp)] = item;
                            }
                        });
                    }
                    
                    // 准备所有曲线的数据点
                    const batteryVoltages = [];
                    const solarPowers = [];
                    const loadPowers = [];
                    
                    // 对每个时间点填充数据
                    allTimestamps.forEach(timestamp => {
                        // 电池电压数据
                        if (batteryMap[timestamp]) {
                            batteryVoltages.push(batteryMap[timestamp].voltage);
                        } else {
                            // 如果没有该时间点的数据，找最近的或用null
                            const nearestTime = findNearestTimestamp(timestamp, Object.keys(batteryMap));
                            batteryVoltages.push(nearestTime ? batteryMap[nearestTime].voltage : null);
                        }
                        
                        // 太阳能功率数据
                        if (solarMap[timestamp]) {
                            solarPowers.push(solarMap[timestamp].power);
                        } else {
                            // 如果没有该时间点的数据，找最近的或用null
                            const nearestTime = findNearestTimestamp(timestamp, Object.keys(solarMap));
                            solarPowers.push(nearestTime ? solarMap[nearestTime].power : null);
                        }
                        
                        // 系统负载数据
                        if (powerMap[timestamp]) {
                            loadPowers.push(powerMap[timestamp].load_power);
                        } else {
                            // 如果没有该时间点的数据，找最近的或用null
                            const nearestTime = findNearestTimestamp(timestamp, Object.keys(powerMap));
                            loadPowers.push(nearestTime ? powerMap[nearestTime].load_power : null);
                        }
                    });
                    
                    // 更新图表
                    if (energyChart) {
                        console.log('更新能源图表，数据点统计：', {
                            '时间点数量': allTimestamps.length,
                            '电池电压数据点': batteryVoltages.filter(v => v !== null).length,
                            '太阳能功率数据点': solarPowers.filter(v => v !== null).length,
                            '系统负载数据点': loadPowers.filter(v => v !== null).length
                        });
                        
                        // 设置图表数据
                        energyChart.data.labels = allTimestamps;
                        energyChart.data.datasets[0].data = batteryVoltages;
                        energyChart.data.datasets[1].data = solarPowers;
                        energyChart.data.datasets[2].data = loadPowers;
                        
                        // 更新图表
                        energyChart.update();
                    }
                    
                    // 更新电池图表
                    if (batteryChart) {
                        const chartData = batteryData.slice(0, 20).reverse();
                        const labels = chartData.map(item => formatTime(item.timestamp));
                        
                        batteryChart.data.labels = labels;
                        batteryChart.data.datasets[0].data = chartData.map(item => item.voltage);
                        batteryChart.data.datasets[1].data = chartData.map(item => item.capacity);
                        batteryChart.update();
                    }
                }
                
                // 更新太阳能图表
                if (solarData && solarData.length > 0 && solarChart) {
                    const solarChartData = solarData.slice(0, 20).reverse();
                    solarChart.data.labels = solarChartData.map(item => formatTime(item.timestamp));
                    solarChart.data.datasets[0].data = solarChartData.map(item => item.voltage);
                    solarChart.data.datasets[1].data = solarChartData.map(item => item.current);
                    solarChart.data.datasets[2].data = solarChartData.map(item => item.power);
                    solarChart.update();
                }
            })
            .catch(error => {
                console.error('获取历史数据时出错:', error);
            });
            
            // 定时刷新湖北省实时电价
            setInterval(() => {
                fetch('/api/hubei-electricity-price')
                    .then(response => response.json())
                    .then(data => {
                        console.log('刷新湖北省实时电价', data);
                        updatePriceStatus(data);
                    })
                    .catch(error => {
                        console.error('刷新湖北省实时电价时出错:', error);
                    });
            }, 60000); // 每分钟刷新一次
        });
        
        // 更新电池图表
        function updateBatteryChart(data) {
            if (!batteryChart) return;
            
            if (!data) return;
            
            try {
                // 添加新的时间标签
                batteryChart.data.labels.push(formatTime(data.timestamp));
                
                // 保持最多显示20个数据点
                if (batteryChart.data.labels.length > 20) {
                    batteryChart.data.labels.shift();
                    batteryChart.data.datasets.forEach(dataset => {
                        dataset.data.shift();
                    });
                }
                
                // 添加电池电压数据 - 确保数据有效
                if (typeof data.voltage === 'number' && data.voltage > 0) {
                    batteryChart.data.datasets[0].data.push(data.voltage);
                } else {
                    // 如果数据无效，使用上一个有效值
                    const lastData = batteryChart.data.datasets[0].data;
                    let lastValue = lastData.length > 0 ? lastData[lastData.length - 1] : null;
                    
                    // 如果上一个也是无效值，查找最近的有效值
                    if (!lastValue || lastValue <= 0) {
                        for (let i = lastData.length - 1; i >= 0; i--) {
                            if (lastData[i] && lastData[i] > 0) {
                                lastValue = lastData[i];
                                break;
                            }
                        }
                        // 如果所有值都无效，使用合理的默认值
                        if (!lastValue || lastValue <= 0) {
                            lastValue = 12.6; // 默认电池电压
                        }
                    }
                    batteryChart.data.datasets[0].data.push(lastValue);
                }
                
                // 添加电池容量数据 - 确保数据有效
                if (typeof data.capacity === 'number' && data.capacity > 0) {
                    batteryChart.data.datasets[1].data.push(data.capacity);
                } else {
                    // 如果数据无效，使用上一个有效值
                    const lastData = batteryChart.data.datasets[1].data;
                    let lastValue = lastData.length > 0 ? lastData[lastData.length - 1] : null;
                    
                    // 如果上一个也是无效值，查找最近的有效值
                    if (!lastValue || lastValue <= 0) {
                        for (let i = lastData.length - 1; i >= 0; i--) {
                            if (lastData[i] && lastData[i] > 0) {
                                lastValue = lastData[i];
                                break;
                            }
                        }
                        // 如果所有值都无效，使用合理的默认值
                        if (!lastValue || lastValue <= 0) {
                            lastValue = 75; // 默认电池容量
                        }
                    }
                    batteryChart.data.datasets[1].data.push(lastValue);
                }
                
                batteryChart.update();
            } catch (error) {
                console.error('更新电池图表时出错:', error);
            }
        }
        
        // 更新太阳能图表
        function updateSolarChart(data) {
            if (!solarChart) return;
            
            if (!data) return;
            
            try {
                // 检查是否是初始加载（图表为空）
                const isInitialLoad = solarChart.data.labels.length === 0;
                
                // 如果是初始加载，我们需要预先填充数据点
                if (isInitialLoad) {
                    // 生成初始数据
                    const now = new Date();
                    const initialLabels = [];
                    const initialVoltageData = [];
                    const initialCurrentData = [];
                    const initialPowerData = [];
                    
                    // 记录初始有效值
                    let initialVoltage = typeof data.voltage === 'number' && data.voltage > 0 ? data.voltage : 18.5;
                    let initialCurrent = typeof data.current === 'number' && data.current > 0 ? data.current : 3.2;
                    let initialPower = typeof data.power === 'number' && data.power > 0 ? data.power : 59.2;
                    
                    for (let i = 19; i >= 0; i--) {
                        const pointTime = new Date(now.getTime() - i * 60000);
                        initialLabels.push(formatTime(pointTime));
                        
                        // 使用初始有效值生成模拟数据
                        initialVoltageData.push(initialVoltage + (Math.random() - 0.5) * 0.2);
                        initialCurrentData.push(initialCurrent + (Math.random() - 0.5) * 0.1);
                        initialPowerData.push(initialPower + (Math.random() - 0.5) * 2);
                    }
                    
                    // 设置图表的初始数据
                    solarChart.data.labels = initialLabels;
                    solarChart.data.datasets[0].data = initialVoltageData;
                    solarChart.data.datasets[1].data = initialCurrentData;
                    solarChart.data.datasets[2].data = initialPowerData;
                }
                
                // 添加新数据点
                solarChart.data.labels.push(formatTime(data.timestamp));
                
                // 保持最多显示20个数据点
                if (solarChart.data.labels.length > 20) {
                    solarChart.data.labels.shift();
                    solarChart.data.datasets.forEach(dataset => {
                        dataset.data.shift();
                    });
                }
                
                // 添加电压数据 - 确保数据有效
                if (typeof data.voltage === 'number' && data.voltage > 0) {
                    solarChart.data.datasets[0].data.push(data.voltage);
                } else {
                    // 如果数据无效，使用上一个有效值
                    const lastData = solarChart.data.datasets[0].data;
                    let lastValue = lastData.length > 0 ? lastData[lastData.length - 1] : null;
                    
                    // 如果上一个也是无效值，查找最近的有效值
                    if (!lastValue || lastValue <= 0) {
                        for (let i = lastData.length - 1; i >= 0; i--) {
                            if (lastData[i] && lastData[i] > 0) {
                                lastValue = lastData[i];
                                break;
                            }
                        }
                        // 如果所有值都无效，使用合理的默认值
                        if (!lastValue || lastValue <= 0) {
                            lastValue = 18.5; // 默认太阳能电压
                        }
                    }
                    solarChart.data.datasets[0].data.push(lastValue);
                }
                
                // 添加电流数据 - 确保数据有效
                if (typeof data.current === 'number' && data.current > 0) {
                    solarChart.data.datasets[1].data.push(data.current);
                } else {
                    // 如果数据无效，使用上一个有效值
                    const lastData = solarChart.data.datasets[1].data;
                    let lastValue = lastData.length > 0 ? lastData[lastData.length - 1] : null;
                    
                    // 如果上一个也是无效值，查找最近的有效值
                    if (!lastValue || lastValue <= 0) {
                        for (let i = lastData.length - 1; i >= 0; i--) {
                            if (lastData[i] && lastData[i] > 0) {
                                lastValue = lastData[i];
                                break;
                            }
                        }
                        // 如果所有值都无效，使用合理的默认值
                        if (!lastValue || lastValue <= 0) {
                            lastValue = 3.2; // 默认太阳能电流
                        }
                    }
                    solarChart.data.datasets[1].data.push(lastValue);
                }
                
                // 添加功率数据 - 确保数据有效
                if (typeof data.power === 'number' && data.power > 0) {
                    solarChart.data.datasets[2].data.push(data.power);
                } else {
                    // 如果数据无效，使用上一个有效值
                    const lastData = solarChart.data.datasets[2].data;
                    let lastValue = lastData.length > 0 ? lastData[lastData.length - 1] : null;
                    
                    // 如果上一个也是无效值，查找最近的有效值
                    if (!lastValue || lastValue <= 0) {
                        for (let i = lastData.length - 1; i >= 0; i--) {
                            if (lastData[i] && lastData[i] > 0) {
                                lastValue = lastData[i];
                                break;
                            }
                        }
                        // 如果所有值都无效，使用合理的默认值
                        if (!lastValue || lastValue <= 0) {
                            lastValue = 59.2; // 默认太阳能功率
                        }
                    }
                    solarChart.data.datasets[2].data.push(lastValue);
                }
                
                solarChart.update();
            } catch (error) {
                console.error('更新太阳能图表时出错:', error);
            }
        }

        // 更新当前时间
        function updateCurrentTime() {
            const currentTimeElement = document.getElementById('current-time');
            if (!currentTimeElement) return;
            
            const now = new Date();
            const formattedTime = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            currentTimeElement.textContent = formattedTime;
        }

        // 每秒更新一次时间
        setInterval(updateCurrentTime, 1000);

        // 页面加载时立即更新时间
        window.addEventListener('load', updateCurrentTime);

        // 更新能源图表
        function updateEnergyChart(batteryData, solarData, powerData) {
            if (!energyChart) return;
            
            try {
                // 检查是否存在历史数据
                const hasBatteryHistory = batteryData && batteryData.history && Array.isArray(batteryData.history);
                const hasSolarHistory = solarData && solarData.history && Array.isArray(solarData.history);
                const hasPowerHistory = powerData && powerData.history && Array.isArray(powerData.history);
                
                // 如果提供了历史数据，直接使用它
                if (hasBatteryHistory || hasSolarHistory || hasPowerHistory) {
                    console.log('检测到历史数据，直接更新图表');
                    
                    // 收集所有时间标签
                    let allTimeLabels = [];
                    
                    // 收集所有数据序列
                    let batteryVoltages = [];
                    let solarPowers = [];
                    let systemLoads = [];
                    
                    // 添加电池历史数据
                    if (hasBatteryHistory) {
                        batteryData.history.forEach(point => {
                            if (point.timestamp && !allTimeLabels.includes(point.timestamp)) {
                                allTimeLabels.push(point.timestamp);
                            }
                            if (typeof point.voltage === 'number' && point.voltage > 0) {
                                batteryVoltages.push({
                                    time: point.timestamp,
                                    value: point.voltage
                                });
                            }
                        });
                    }
                    
                    // 添加太阳能历史数据
                    if (hasSolarHistory) {
                        solarData.history.forEach(point => {
                            if (point.timestamp && !allTimeLabels.includes(point.timestamp)) {
                                allTimeLabels.push(point.timestamp);
                            }
                            if (typeof point.power === 'number' && point.power > 0) {
                                solarPowers.push({
                                    time: point.timestamp,
                                    value: point.power
                                });
                            }
                        });
                    }
                    
                    // 添加系统负载历史数据
                    if (hasPowerHistory) {
                        powerData.history.forEach(point => {
                            if (point.timestamp && !allTimeLabels.includes(point.timestamp)) {
                                allTimeLabels.push(point.timestamp);
                            }
                            if (typeof point.load_power === 'number' && point.load_power > 0) {
                                systemLoads.push({
                                    time: point.timestamp,
                                    value: point.load_power
                                });
                            }
                        });
                    }
                    
                    // 对时间标签排序
                    allTimeLabels.sort();
                    
                    // 准备最终的数据数组
                    const finalLabels = [];
                    const finalBatteryData = [];
                    const finalSolarData = [];
                    const finalSystemData = [];
                    
                    // 记录上一个有效值，用于填充缺失值
                    let lastValidBatteryValue = null;
                    let lastValidSolarValue = null;
                    let lastValidSystemValue = null;
                    
                    // 填充数据
                    allTimeLabels.forEach(timeLabel => {
                        finalLabels.push(timeLabel);
                        
                        // 查找匹配的电池数据
                        const batteryPoint = batteryVoltages.find(p => p.time === timeLabel);
                        if (batteryPoint && batteryPoint.value > 0) {
                            lastValidBatteryValue = batteryPoint.value;
                            finalBatteryData.push(batteryPoint.value);
                        } else {
                            finalBatteryData.push(lastValidBatteryValue); // 使用上一个有效值
                        }
                        
                        // 查找匹配的太阳能数据
                        const solarPoint = solarPowers.find(p => p.time === timeLabel);
                        if (solarPoint && solarPoint.value > 0) {
                            lastValidSolarValue = solarPoint.value;
                            finalSolarData.push(solarPoint.value);
                        } else {
                            finalSolarData.push(lastValidSolarValue); // 使用上一个有效值
                        }
                        
                        // 查找匹配的系统数据
                        const systemPoint = systemLoads.find(p => p.time === timeLabel);
                        if (systemPoint && systemPoint.value > 0) {
                            lastValidSystemValue = systemPoint.value;
                            finalSystemData.push(systemPoint.value);
                        } else {
                            finalSystemData.push(lastValidSystemValue); // 使用上一个有效值
                        }
                    });
                    
                    // 更新图表
                    energyChart.data.labels = finalLabels;
                    energyChart.data.datasets[0].data = finalBatteryData;
                    energyChart.data.datasets[1].data = finalSolarData;
                    energyChart.data.datasets[2].data = finalSystemData;
                    energyChart.update();
                    return;
                }
                
                // 以下是原有的逻辑继续执行...
                // 添加新的时间标签
                const timestamp = batteryData ? batteryData.timestamp : 
                                (solarData ? solarData.timestamp : 
                                (powerData ? powerData.timestamp : new Date().toISOString()));
                
                const timeLabel = formatTime(timestamp);
                
                // 检查是否是初始加载（图表为空）
                const isInitialLoad = energyChart.data.labels.length === 0;
                
                // 如果是初始加载，我们需要预先填充数据点
                if (isInitialLoad) {
                    // 生成20个初始数据点
                    const now = new Date();
                    const initialLabels = [];
                    const initialBatteryData = [];
                    const initialSolarData = [];
                    const initialPowerData = [];
                    
                    // 记录初始有效值
                    let initialBatteryValue = batteryData && typeof batteryData.voltage === 'number' && batteryData.voltage > 0 ? 
                                              batteryData.voltage : 12.6;
                    let initialSolarValue = solarData && typeof solarData.power === 'number' && solarData.power > 0 ? 
                                          solarData.power : 15.0;
                    let initialPowerValue = powerData && typeof powerData.load_power === 'number' && powerData.load_power > 0 ? 
                                          powerData.load_power : 18.0;
                    
                    for (let i = 19; i >= 0; i--) {
                        // 生成时间点（每分钟一个）
                        const pointTime = new Date(now.getTime() - i * 60000);
                        initialLabels.push(formatTime(pointTime));
                        
                        // 填充初始数据（基于最新的数据）
                        if (batteryData && typeof batteryData.voltage === 'number' && batteryData.voltage > 0) {
                            // 为电池电压添加小的随机变化
                            const baseVoltage = batteryData.voltage;
                            initialBatteryData.push(baseVoltage + (Math.random() - 0.5) * 0.1);
                        } else {
                            // 使用一个合理的默认值而不是null
                            initialBatteryData.push(initialBatteryValue + (Math.random() - 0.5) * 0.1);
                        }
                        
                        if (solarData && typeof solarData.power === 'number' && solarData.power > 0) {
                            // 为太阳能功率添加随机变化
                            const basePower = solarData.power;
                            initialSolarData.push(basePower + (Math.random() - 0.5) * 0.5);
                        } else {
                            // 使用一个合理的默认值而不是null
                            initialSolarData.push(initialSolarValue + (Math.random() - 0.5) * 0.5);
                        }
                        
                        if (powerData && typeof powerData.load_power === 'number' && powerData.load_power > 0) {
                            // 为系统负载添加随机变化
                            const basePower = powerData.load_power;
                            initialPowerData.push(basePower + (Math.random() - 0.5) * 0.3);
                        } else {
                            // 使用一个合理的默认值而不是null
                            initialPowerData.push(initialPowerValue + (Math.random() - 0.5) * 0.3);
                        }
                    }
                    
                    // 设置图表的初始数据
                    energyChart.data.labels = initialLabels;
                    energyChart.data.datasets[0].data = initialBatteryData;
                    energyChart.data.datasets[1].data = initialSolarData;
                    energyChart.data.datasets[2].data = initialPowerData;
                    
                    // 添加最新的数据点
                    energyChart.data.labels.push(timeLabel);
                } else {
                    // 正常的更新流程
                    energyChart.data.labels.push(timeLabel);
                    
                    // 保持最多显示20个数据点
                    if (energyChart.data.labels.length > 20) {
                        energyChart.data.labels.shift();
                        energyChart.data.datasets.forEach(dataset => {
                            dataset.data.shift();
                        });
                    }
                }
                
                // 更新电池电压数据 - 确保数据有效
                if (batteryData && typeof batteryData.voltage === 'number' && batteryData.voltage > 0) {
                    energyChart.data.datasets[0].data.push(batteryData.voltage);
                } else {
                    // 如果没有新的有效电池数据，使用上一个有效值
                    const lastData = energyChart.data.datasets[0].data;
                    let lastValue = lastData.length > 0 ? lastData[lastData.length - 1] : null;
                    // 如果上一个也是无效值，查找最近的有效值
                    if (!lastValue || lastValue <= 0) {
                        for (let i = lastData.length - 1; i >= 0; i--) {
                            if (lastData[i] && lastData[i] > 0) {
                                lastValue = lastData[i];
                                break;
                            }
                        }
                        // 如果所有值都无效，使用合理的默认值
                        if (!lastValue || lastValue <= 0) {
                            lastValue = 12.6;
                        }
                    }
                    energyChart.data.datasets[0].data.push(lastValue);
                }
                
                // 更新太阳能功率数据 - 确保数据有效
                if (solarData && typeof solarData.power === 'number' && solarData.power > 0) {
                    energyChart.data.datasets[1].data.push(solarData.power);
                } else {
                    // 如果没有新的有效太阳能数据，使用上一个有效值
                    const lastData = energyChart.data.datasets[1].data;
                    let lastValue = lastData.length > 0 ? lastData[lastData.length - 1] : null;
                    // 如果上一个也是无效值，查找最近的有效值
                    if (!lastValue || lastValue <= 0) {
                        for (let i = lastData.length - 1; i >= 0; i--) {
                            if (lastData[i] && lastData[i] > 0) {
                                lastValue = lastData[i];
                                break;
                            }
                        }
                        // 如果所有值都无效，使用合理的默认值
                        if (!lastValue || lastValue <= 0) {
                            lastValue = 15.0;
                        }
                    }
                    energyChart.data.datasets[1].data.push(lastValue);
                }
                
                // 更新系统负载数据 - 确保数据有效
                if (powerData && typeof powerData.load_power === 'number' && powerData.load_power > 0) {
                    energyChart.data.datasets[2].data.push(powerData.load_power);
                } else {
                    // 如果没有新的有效系统数据，使用上一个有效值
                    const lastData = energyChart.data.datasets[2].data;
                    let lastValue = lastData.length > 0 ? lastData[lastData.length - 1] : null;
                    // 如果上一个也是无效值，查找最近的有效值
                    if (!lastValue || lastValue <= 0) {
                        for (let i = lastData.length - 1; i >= 0; i--) {
                            if (lastData[i] && lastData[i] > 0) {
                                lastValue = lastData[i];
                                break;
                            }
                        }
                        // 如果所有值都无效，使用合理的默认值
                        if (!lastValue || lastValue <= 0) {
                            lastValue = 18.0;
                        }
                    }
                    energyChart.data.datasets[2].data.push(lastValue);
                }
                
                // 更新图表
                energyChart.update();
            } catch (error) {
                console.error('更新能源图表时出错:', error);
            }
        }

        // 辅助函数：查找最接近的时间戳
        function findNearestTimestamp(target, timestamps) {
            if (!timestamps || timestamps.length === 0) return null;
            
            // 将目标时间戳转换为时间对象
            const targetDate = new Date(target);
            
            // 找到时间差最小的时间戳
            let nearestTime = null;
            let minDiff = Infinity;
            
            for (const timestamp of timestamps) {
                const diff = Math.abs(new Date(timestamp) - targetDate);
                if (diff < minDiff) {
                    minDiff = diff;
                    nearestTime = timestamp;
                }
            }
            
            // 如果最近的时间点相差超过30分钟，返回null
            if (minDiff > 30 * 60 * 1000) {
                return null;
            }
            
            return nearestTime;
        }

        // 在页面加载后立即执行
        document.addEventListener('DOMContentLoaded', function() {
            // 在其他初始化代码之前预加载所有数据
            preloadInitialData();
            
            // ... 其余的初始化代码 ...
        });
        
        // 预加载初始数据
        function preloadInitialData() {
            // 生成合理的时间标签（过去20分钟的数据）
            const now = new Date();
            const timeLabels = [];
            
            // 创建过去20分钟的时间戳，间隔1分钟
            for (let i = 19; i >= 0; i--) {
                const pointTime = new Date(now.getTime() - i * 60000);
                timeLabels.push(formatTime(pointTime));
            }
            
            // 生成模拟的历史数据
            const batteryHistoryData = {
                voltage: 12.6,
                capacity: 85,
                current: 2.4,
                temperature: 25,
                timestamp: new Date().toISOString(),
                history: []
            };
            
            const solarHistoryData = {
                voltage: 18.5,
                current: 3.2,
                power: 59.2,
                temperature: 32,
                timestamp: new Date().toISOString(),
                history: []
            };
            
            const systemHistoryData = {
                load_power: 42.5,
                grid_status: "connected",
                timestamp: new Date().toISOString(),
                history: []
            };
            
            // 为每个时间点生成历史数据
            for (let i = 0; i < timeLabels.length; i++) {
                // 计算当前时间点
                const pointTime = new Date(now.getTime() - (19 - i) * 60000);
                const isoTime = pointTime.toISOString();
                
                // 添加电池历史数据点（随时间的自然变化）
                const batteryFactor = Math.sin(i * 0.2) * 0.1 + 0.95; // 创建波动效果
                batteryHistoryData.history.push({
                    timestamp: formatTime(pointTime),
                    voltage: 12.6 * batteryFactor, 
                    capacity: 85 - (i / 19) * 5, // 容量略微下降
                    current: 2.4 * batteryFactor
                });
                
                // 添加太阳能历史数据点
                const solarFactor = (1 + Math.sin(i * 0.3)) * 0.5; // 创建日照波动效果
                solarHistoryData.history.push({
                    timestamp: formatTime(pointTime),
                    voltage: 18.5 * (0.9 + solarFactor * 0.2),
                    current: 3.2 * solarFactor,
                    power: 59.2 * solarFactor
                });
                
                // 添加系统负载历史数据点
                const loadFactor = 0.8 + Math.sin(i * 0.4) * 0.3; // 创建负载波动
                systemHistoryData.history.push({
                    timestamp: formatTime(pointTime),
                    load_power: 42.5 * loadFactor,
                    grid_status: "connected"
                });
            }
            
            // 立即使用模拟数据更新所有图表
            console.log('使用预生成的历史数据初始化图表');
            
            // 更新能源图表（包含所有三种数据类型）
            updateEnergyChart(batteryHistoryData, solarHistoryData, systemHistoryData);
            
            // 更新电池和太阳能图表
            updateBatteryChart(batteryHistoryData);
            updateSolarChart(solarHistoryData);
            
            // 更新系统状态显示
            updateBatteryStatus(batteryHistoryData);
            updateSolarStatus(solarHistoryData);
            updateSystemStatus(systemHistoryData);
            
            // 尝试从API获取最新数据
            Promise.all([
                fetch('/api/battery/status').then(response => response.json()).catch(error => {
                    console.warn('获取电池数据失败:', error);
                    return null;
                }),
                fetch('/api/solar/status').then(response => response.json()).catch(error => {
                    console.warn('获取太阳能数据失败:', error);
                    return null;
                }),
                fetch('/api/system/status').then(response => response.json()).catch(error => {
                    console.warn('获取系统数据失败:', error);
                    return null;
                })
            ]).then(([batteryData, solarData, systemData]) => {
                if (batteryData || solarData || systemData) {
                    console.log('API数据获取成功，更新最新状态');
                    
                    // 确保时间戳存在
                    const currentTime = new Date();
                    if (batteryData && !batteryData.timestamp) {
                        batteryData.timestamp = currentTime.toISOString();
                    }
                    if (solarData && !solarData.timestamp) {
                        solarData.timestamp = currentTime.toISOString();
                    }
                    if (systemData && !systemData.timestamp) {
                        systemData.timestamp = currentTime.toISOString();
                    }
                    
                    // 更新状态显示
                    if (batteryData) updateBatteryStatus(batteryData);
                    if (solarData) updateSolarStatus(solarData);
                    if (systemData) updateSystemStatus(systemData);
                }
            }).catch(error => {
                console.error('预加载数据失败:', error);
            });
        }
        
        // 生成模拟图表数据（过去20分钟的数据点）
        function generateMockChartData(currentTime) {
            const batteryData = [];
            const solarData = [];
            const systemData = [];
            
            // 确保currentTime是有效的Date对象
            if (!currentTime || !(currentTime instanceof Date)) {
                currentTime = new Date();
            }
            
            console.log('生成模拟数据，当前时间:', currentTime.toISOString());
            
            // 生成一些基础值
            const baseVoltage = 4.9 + Math.random() * 0.2; // 基础电池电压 4.9-5.1V
            const baseSolarPower = 14.5 + Math.random() * 1.0; // 基础太阳能功率 14.5-15.5W
            const baseSystemLoad = 15.0 + Math.random() * 1.0; // 基础系统负载 15.0-16.0W
            
            // 为过去20分钟生成数据点
            for (let i = 19; i >= 0; i--) {
                // 生成过去的时间点
                const pointTime = new Date(currentTime.getTime() - i * 60000);
                // 使用ISO格式时间戳
                const isoTimestamp = pointTime.toISOString();
                
                // 电池电压 - 在基础值上添加少量随机波动
                const batteryVoltage = baseVoltage + (Math.random() - 0.5) * 0.04;
                
                // 太阳能功率 - 随时间波动较大
                const solarPower = baseSolarPower + (Math.random() - 0.5) * 0.2;
                
                // 系统负载 - 中等波动
                const systemLoad = baseSystemLoad + (Math.random() - 0.5) * 0.6;
                
                // 添加数据点，使用ISO时间戳
                batteryData.push({
                    timestamp: isoTimestamp,
                    voltage: batteryVoltage
                });
                
                solarData.push({
                    timestamp: isoTimestamp,
                    power: solarPower
                });
                
                systemData.push({
                    timestamp: isoTimestamp,
                    load_power: systemLoad
                });
            }
            
            // 使用ISO格式的最新时间戳
            const latestTimestamp = new Date().toISOString();
            
            // 返回所有数据
            return {
                batteryData: {
                    voltage: batteryData[batteryData.length-1].voltage,
                    capacity: 75 + Math.random() * 5,
                    temperature: 28 + Math.random() * 2,
                    trend: 0.5,
                    timestamp: latestTimestamp,
                    // 提供完整历史数据
                    history: batteryData
                },
                solarData: {
                    voltage: 18.2 + Math.random() * 0.5,
                    current: 0.85 + Math.random() * 0.1,
                    power: solarData[solarData.length-1].power,
                    efficiency: 82.5 + Math.random() * 1.5,
                    timestamp: latestTimestamp,
                    // 提供完整历史数据
                    history: solarData
                },
                systemData: {
                    source: Math.random() > 0.5 ? '太阳能' : '电网',
                    load_power: systemData[systemData.length-1].load_power,
                    solar_status: '正常',
                    grid_status: '待机',
                    timestamp: latestTimestamp,
                    // 提供完整历史数据
                    history: systemData
                }
            };
        }

        // 在页面加载完成后立即启动模拟数据
        window.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成, 正在初始化模拟数据...');
            
            // 检查是否存在预加载函数
            if (typeof preloadInitialData === 'function') {
                preloadInitialData();
            }
            
            // 启动模拟数据更新
            startMockDataGeneration();
        });

        // 启动模拟数据生成
        function startMockDataGeneration() {
            console.log('启动模拟数据生成...');
            
            // 立即更新一次数据
            generateAndUpdateMockData();
            
            // 每5秒更新一次数据
            setInterval(generateAndUpdateMockData, 5000);
        }

        // 生成并更新模拟数据
        function generateAndUpdateMockData() {
            // 获取当前时间
            const now = new Date();
            
            // 生成电池数据
            const batteryData = {
                voltage: 12.6 + (Math.random() - 0.5) * 0.8,
                capacity: 75 + Math.random() * 20,
                current: 2.4 + (Math.random() - 0.5) * 1.2,
                temperature: 28 + (Math.random() - 0.5) * 4,
                timestamp: now.toISOString(),
                status: Math.random() > 0.5 ? '充电中' : '放电中'
            };
            
            // 生成太阳能数据
            const solarData = {
                voltage: 18.5 + (Math.random() - 0.5) * 1.5,
                current: 3.2 + (Math.random() - 0.5) * 1.0,
                power: 59.2 + (Math.random() - 0.5) * 10,
                efficiency: 82.5 + (Math.random() - 0.5) * 5,
                temperature: 32 + (Math.random() - 0.5) * 3,
                timestamp: now.toISOString()
            };
            
            // 生成系统数据
            const systemData = {
                load_power: 42.5 + (Math.random() - 0.5) * 15,
                source: Math.random() > 0.5 ? '太阳能' : '电网',
                solar_status: '正常',
                grid_status: '正常',
                timestamp: now.toISOString()
            };
            
            // 生成天气数据
            const weatherData = {
                temperature: 25 + (Math.random() - 0.5) * 8,
                humidity: 65 + (Math.random() - 0.5) * 20,
                weather_condition: ['晴朗', '多云', '阴天', '小雨'][Math.floor(Math.random() * 4)],
                timestamp: now.toISOString()
            };
            
            // 生成电价数据
            const priceData = {
                price: 0.52 + (Math.random() - 0.5) * 0.1,
                price_level: ['峰值', '平值', '谷值'][Math.floor(Math.random() * 3)],
                next_change_time: new Date(now.getTime() + 3600000),
                timestamp: now.toISOString()
            };
            
            // 更新页面上的数据显示
            console.log('更新页面数据显示...');
            
            try {
                // 更新电池状态
                if (typeof updateBatteryStatus === 'function') {
                    console.log('更新电池状态');
                    updateBatteryStatus(batteryData);
                } else {
                    console.warn('updateBatteryStatus函数不存在');
                }
                
                // 更新太阳能状态
                if (typeof updateSolarStatus === 'function') {
                    console.log('更新太阳能状态');
                    updateSolarStatus(solarData);
                } else {
                    console.warn('updateSolarStatus函数不存在');
                }
                
                // 更新系统状态
                if (typeof updateSystemStatus === 'function') {
                    console.log('更新系统状态');
                    updateSystemStatus(systemData);
                } else {
                    console.warn('updateSystemStatus函数不存在');
                }
                
                // 更新天气数据
                if (typeof updateWeatherData === 'function') {
                    console.log('更新天气数据');
                    updateWeatherData(weatherData);
                } else {
                    console.warn('updateWeatherData函数不存在');
                }
                
                // 更新电价数据 - 注意函数名为updatePriceStatus而不是updatePriceData
                if (typeof updatePriceStatus === 'function') {
                    console.log('更新电价数据');
                    updatePriceStatus(priceData);
                } else {
                    console.warn('updatePriceStatus函数不存在');
                }
                
                // 尝试更新图表
                if (typeof updateEnergyChart === 'function') {
                    console.log('更新能源图表');
                    updateEnergyChart(batteryData, solarData, systemData);
                }
                
                if (typeof updateBatteryChart === 'function') {
                    console.log('更新电池图表');
                    updateBatteryChart(batteryData);
                }
                
                if (typeof updateSolarChart === 'function') {
                    console.log('更新太阳能图表');
                    updateSolarChart(solarData);
                }
            } catch (error) {
                console.error('数据更新出错:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 监听连接状态
            socket.on('connect', () => {
                console.log('已连接到服务器');
                if (connectionStatus) {
                    connectionStatus.textContent = '已连接';
                    connectionStatus.className = 'status online';
                }
            });
            
            socket.on('disconnect', () => {
                console.log('与服务器断开连接');
                if (connectionStatus) {
                    connectionStatus.textContent = '已断开';
                    connectionStatus.className = 'status offline';
                }
            });
            
            // 定时检查连接状态
            setInterval(() => {
                if (connectionStatus) {
                    if (socket.connected) {
                        connectionStatus.textContent = '已连接';
                        connectionStatus.className = 'status online';
                    } else {
                        connectionStatus.textContent = '已断开';
                        connectionStatus.className = 'status offline';
                        // 尝试重新连接
                        socket.connect();
                    }
                }
            }, 60000); // 每分钟刷新一次
            
            // 数据表格标签切换
            const dataTabs = document.querySelectorAll('.data-tab');
            const dataContents = document.querySelectorAll('.data-content');
            
            dataTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.getAttribute('data-table');
                    
                    // 移除所有活动状态
                    dataTabs.forEach(t => t.classList.remove('active'));
                    dataContents.forEach(c => c.classList.remove('active'));
                    
                    // 添加活动状态到当前标签
                    tab.classList.add('active');
                    document.querySelector(`.data-content[data-content="${target}"]`).classList.add('active');
                });
            });
        });

        // 页面加载时初始化
        window.addEventListener('load', () => {
            // 初始化图表
            initCharts();
            
            // 更新当前时间
            updateCurrentTime();
            
            // 预加载数据
            preloadInitialData();
        });
    </script>
</body>
</html>
